# # Build Stage
# FROM node:23-slim AS builder
# WORKDIR /app

# COPY package*.json ./
# RUN npm install
# COPY . .

# ENV NODE_OPTIONS=--max-old-space-size=2048
# RUN npm run build


# # Production stage
# FROM node:23-slim
# WORKDIR /app
# COPY --from=builder /app/dist ./dist
# COPY --from=builder /app/package.json /app/package-lock.json ./
# RUN npm install --no-optional && npm cache clean --force



# EXPOSE 5000
# CMD ["npm", "start"]


# Build Stage
FROM node:23-slim AS builder
WORKDIR /app

COPY package*.json ./
RUN npm install
COPY . .

ENV NODE_OPTIONS=--max-old-space-size=2048
RUN npm run build


# Production Stage
FROM node:23-slim
WORKDIR /app

# Copy compiled dist folder and all runtime-relevant files
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/middleware ./middleware  # <--- ADD THIS if used in dist
COPY --from=builder /app/.env ./  # Optional: if you use .env variables

EXPOSE 5000

CMD ["node", "dist/server.js"]

